<!-- Mapbox CSS -->
<link href="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css" rel="stylesheet" />

<!-- Mapbox Geocoder CSS -->
<link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css"
    rel="stylesheet" />

<!-- Custom CSS -->
<style>
    /* Base Styles */
    body {
        background-color: #e8e1d6 !important;
    }

    html {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: 'Roboto', sans-serif;
    }

    /* Container */
    .main-container {
        display: flex;
        height: 100%;
        flex-direction: column;
    }

    /* Search Container */
    .search-container {
        position: fixed;
        top: 80px;
        left: 0;
        right: 0;
        background: #1f363e;
        padding: 10px 15px;
        z-index: 10;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        justify-content: center;
        height: 115px;
    }


    .search-right {
        display: flex;
        flex-wrap: nowrap;
        align-items: center;
        margin-left: 10px;
    }

    .search-right>* {
        margin-right: 10px;
        /* margin-bottom: 10px; */
    }

    #geocoder {
        width: 100%;
    }

    .search-container select {
        padding: 8px;
        border: none;
        border-radius: 0px;
        background-color: #ffffff;
        color: #222222;
        margin-bottom: 15px;
    }

    .search-container input[type="number"] {
        padding: 8px;
        border: none;
        border-radius: 0px;
        background-color: #ffffff;
        color: #000000;
    }

    select:focus-visible {
        outline: none;
    }

    .search-container button {
        background-color: transparent;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 9.6px 16px 6.4px;
    }

    .mapboxgl-ctrl-geocoder {
        width: 100%;
        position: relative;
    }

    .mapboxgl-ctrl-geocoder--icon {
        width: 24px;
        height: 24px;
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
    }

    .mapboxgl-ctrl-geocoder--input {
        padding-left: 40px;
    }

    /* More Filters */
    .more-filters {
        position: relative;
    }

    .more-filters-content {
        display: none;
        position: absolute;
        top: 40px;
        right: 0;
        background: #f1f1f1;
        /* padding: 15px; */
        border: 1px solid #ccc;
        /* border-radius: 4px; */
        z-index: 1000;
        min-width: 250px;
    }

    @media screen and (min-width: 767px) {
        .more-filters-filter {
            padding: 20px;
            max-height: 60vh;
            overflow: auto;
        }
    }

    .more-filters-content.show {
        display: block;
    }

    .more-filters-content input[type="number"] {
        display: block;
        margin-bottom: 10px;
        width: 115px;
        height: 30px;
    }

    input[type="text"],
    input[type="number"],
    input[type="email"],
    input[type="url"],
    input[type="password"],
    input[type="search"],
    input[type=reset],
    input[type=tel],
    input[type=date],
    select,
    textarea {
        font-size: 16px;
        font-style: normal;
        font-weight: 400;
        line-height: 24px;
        width: 100%;
        padding: 12px 38px;
        border-radius: 4px;
        box-shadow: 0px 1px 2px 0px rgba(0, 0, 0, 0.05);
        color: var(--ast-form-input-text, #475569);
    }

    option {
        color: black;
    }

    .square-feet,
    .lot-size {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }

    h4.more-filters-title {
        color: #222222;
        font-size: 14px;
        font-family: 'Albert Sans', sans-serif;
        margin-bottom: 10px;
    }

    label.more-filters-label {
        display: flex;
        gap: 10px;
        width: 185px;
        align-items: center;
        background-color: #ffffff;
        padding: 10px;
        margin-bottom: 15px;
    }


    /* Map and Listing */
    .map-and-listing {
        display: flex;
        flex: 1;
        margin-top: 60px;
        overflow: hidden;
    }

    .map-container {
        width: 50%;
        position: relative;
    }

    .listing-container {
        width: 50%;
        padding: 15px;
        background-color: #e8e1d6;
        box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
        height: calc(100vh - 195px);
        overflow-y: auto;
    }

    /* location title */
    h1.location-title {
        margin-bottom: 0px;
    }

    /* property count */
    h4.property-count {
        margin-bottom: 0px;
        font-family: 'Albert Sans', sans-serif;
        font-size: 16px;
        font-weight: 400;
    }

    h4.view-toggle-title {
        font-size: 16px;
        color: #222222;
        margin-bottom: 0px;
        font-family: 'Albert Sans', sans-serif;
    }

    .sorrting-div {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* sort div*/
    select#sort-by {
        padding: 0px 10px;
        width: 200px;
        height: 30px;
        background: transparent;
        border: none;
    }

    /* Property Item */
    .property-item {
        margin-bottom: 0px;
        border: 1px solid #ddd;
        /* background-color: #fff; */
        box-shadow: rgba(0, 0, 0, 0.3) 0px 2px 4px 0px;
        cursor: pointer;
        position: relative;
    }

    .property-image-container {
        position: relative;
        width: 100%;
        height: 212px;
        /* margin-bottom: -12px; */
        /* margin-top: -26px; */
        overflow: hidden;
        /* Ensures overlay and image stay within bounds */
    }

    .property-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: relative;
        /* top: -26px; */
    }

    /* image layour */
    .property-image-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 0) 50%, rgba(0, 0, 0, 0.75) 100%);
        opacity: 1;
        pointer-events: none;
        z-index: 1;
    }

    /* hover effect for images */
    .property-image-container:hover::before {
        background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.1) 50%, rgba(10, 0, 0, 10) 100%);
    }

    .details {
        padding: 10px 10px 10px 10px;
    }

    .list-view .property-item {
        display: flex;
        align-items: center;
    }

    .list-view .property-image {
        width: 120px;
        height: 80px;
        margin-right: 15px;
        object-fit: cover;
    }

    .list-view .details {
        flex: 1;
        padding-left: 15px;
    }

    .price {
        position: absolute;
        font-weight: bold;
        color: #fff;
        margin-top: -45px;
        left: 20px;
        z-index: 2;
    }

    /* Property Details */
    .details p {
        margin: 0px 0;
    }

    p.property-name {
        font-weight: 600;
        font-size: 16px;
    }

    p.property-address {
        margin-bottom: 10px;
        color: #636363;
        font-weight: 600;
        font-size: 13px;
        -o-text-overflow: ellipsis;
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
    }

    p.property-amenities {
        color: #222222;
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 10px;
    }

    p.property-type {
        font-size: 12px;
        font-weight: 600;
        color: #1a1a1a;
    }

    /* Grid and List Views */
    .grid-view {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
    }

    .list-view {
        display: block;
    }

    /* Mapbox Popup */
    .mapboxgl-popup {
        max-width: 300px !important;
        min-width: 290px !important;
    }

    .mapboxgl-popup-content {
        border-radius: 0px;
        padding: 7px;
    }

    .property-map-card {
        display: flex;
        gap: 10px;
    }

    .property-map-image-container {
        width: 40%;
    }

    .property-map-details {
        display: flex;
        flex-direction: column;
        width: 60%;
    }

    img.property-map-image {
        height: 85px;
        border-radius: 5px;
        object-fit: cover;
    }

    h3.property-map-title {
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 0px;
        font-family: 'Albert Sans', sans-serif;
    }

    p.property-map-price {
        font-size: 12px;
        font-weight: 500;
        margin-bottom: 0px;
        font-family: 'Albert Sans', sans-serif;
    }

    p.property-map-type {
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 0px;
        text-transform: uppercase;
        font-family: 'Albert Sans', sans-serif;
    }

    .mapboxgl-popup-close-button {
        width: 20px;
        padding: 0px;
        top: 1px;
        right: -20px;
        background: white;
        font-size: 20px;
        color: black;
    }

    .mapboxgl-popup-close-button:hover {
        background-color: rgb(0 0 0);
    }


    /* .mapboxgl-popup */

    /* View Toggle Buttons */
    .view-toggle {
        margin: 10px 0;
        display: flex;
        justify-content: space-between;
    }

    .view-toggle button {
        padding: 8px;
        margin-left: 10px;
        cursor: pointer;
    }

    .view-toggle button:active {
        background: #121d21;
    }

    /* Hide Mobile Toggle Buttons on Desktop */
    .mobile-toggle-buttons {
        display: none;
    }

    /* Highlight on hover */
    .property-item:hover {
        box-shadow: 0px 0px 15px rgba(30, 30, 30, 0.5);
    }

    .location-title,
    .property-count {
        color: #000000 !important;

    }

    .more-filters-fixed-buttons {
        display: flex;

    }


    button.apply-filters-btn-mobile {
        display: none;
    }

    button#apply-filters-btn {
        width: 100%;
        background-color: #000000;
        display: block;
    }

    .more-filters-mobile-only {
        display: none;
    }

    @media screen and (min-width: 1577px) {
        .listing-container {
            width: 35%;
            height: calc(100vh - 195px);
        }

        .map-container {
            width: 65%;
            position: relative;
            height: 79.5vh;
        }
    }

    @media screen and (min-width: 1363px) {
        .search-left {
            /* flex: 1; */
            min-width: 500px;
        }

        /* .property-item {
            width: 283px;
        }

        .property-item img {
            width: 283px;
            height: 212px;
        } */
    }


    @media screen and (min-width: 640px) {
        .mapboxgl-ctrl-geocoder {
            width: 100%;
            font-size: 15px;
            line-height: 20px;
            max-width: none;
        }
    }

    @media screen and (min-width: 768px) and (max-width: 835px) {
        .search-left {
            width: 500px;
        }
    }


    /* Responsive Styles */
    @media (max-width: 767px) {

        #filter-bedrooms-wrapper,
        #filter-baths-wrapper {
            display: none;
        }

        .more-filters-mobile-only {
            display: block;
        }

        .more-filters-phone-only {
            padding: 20px;
        }

        .close-filters {
            display: flex !important;
            border-bottom: 1px solid #d1d1d5;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
            padding: 15px;
        }

        .more-filters-fixed-buttons {
            display: flex;
            justify-content: space-evenly;
            position: fixed;
            bottom: 10px;
            width: 100vw;
        }

        button.apply-filters-btn-desktop {
            display: none;
        }

        button.apply-filters-btn-mobile {
            display: block;
            width: 40%;
            background: #00000000;
            color: black;
            text-align: right;
            padding: 0px 0px 10px 0px;
        }

        button#apply-filters-btn {
            color: #1F363E;
            background: #00000000;
            width: 40%;
            display: block;
            font-weight: bolder;
            font-family: 'Albert Sans', sans-serif;
            text-align: left;
            padding: 0px 0px 10px 0px;
        }

        /* Adjust Container */
        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Hide View Toggle */
        .view-toggle {
            display: none;
        }

        /* Map and Listing Stack */
        .map-and-listing {
            /* flex-direction: column; */
            flex: 1;
            margin-top: 0px;
            overflow: hidden;
        }

        .map-container,
        .listing-container {
            width: 100%;
            flex: 1;
            display: none;
            overflow-y: auto;
        }

        /* Show Listing by Default */
        .listing-container {
            display: block;
        }

        /* Adjust Heights */
        .map-container {
            height: calc(100vh - 202px);
        }

        .listing-container {
            height: calc(100vh - 140px);
            padding-bottom: 55px;
        }

        /* Mobile Toggle Buttons */
        .mobile-toggle-buttons {
            display: flex;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1f363e;
            border-top: 1px solid #ccc;
            z-index: 9;
        }

        .mobile-toggle-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
        }

        .mobile-toggle-buttons button.active {
            background-color: #121d21;
        }

        .mobile-toggle-buttons i {
            display: block;
            font-size: 20px;
            margin-bottom: 3px;
        }

        #mobile-listing-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        #mobile-map-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }



        /* .map-and-listing {
            /* margin-bottom: 60px; */
        /* } */

        /* Search Container */
        .search-container {
            flex-wrap: wrap;
            position: sticky;
            top: 0;
            padding: 10px;
            height: 90px;
        }

        .search-left,
        .search-right {
            flex: 1 1 100%;
        }

        .search-right {
            margin-left: 0;
            flex-wrap: nowrap;
        }

        .search-right>* {
            flex: 1 1 calc(50% - 10px);
            margin-right: 10px;
            margin-bottom: 10px;
        }

        /* Property Item */
        .property-item {
            padding: 10px;
            margin-bottom: 0px;
        }

        .list-view .property-image {
            width: 80px;
            height: 60px;
        }

        .details p {
            margin: 3px 0;
            font-size: 14px;
        }

        .price {
            font-size: 16px;
        }

        /* Grid View Adjustments */
        .grid-view {
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .grid-view .property-item {
            padding: 0px;
        }

        .grid-view .property-image {
            height: 177px;
            object-fit: cover;
        }

        /* More Filters Position */
        .more-filters-content {
            position: fixed;
            width: 100vw;
            height: 100vh;
            top: 0px;
            z-index: 9999999;
        }

        /* wordpress styles */
        .ast-container {
            padding: 0 !important;
        }
    }

    /* wordpress styles ends here*/


    /* featured property */
    .featured-label {
        background-color: #3d3c3661;
        position: absolute;
        font-size: 12px;
        color: #fff9f9;
        padding: 0px 5px;
        top: 10px;
        margin-left: 6px;
        font-weight: 500;
        z-index: 9;
    }

    .nofeatured {
        visibility: hidden;
    }

    .toggle-icon {
        width: 20px;
        height: 20px;
        transition: transform 0.3s;
    }

    /* Rotate icon when popup is visible */
    .rotate-icon {
        transform: rotate(180deg);
    }

    /* Style for the popup */
    .popup {
        position: absolute;
        background-color: #fff;
        border: 1px solid #ccc;
        border-radius: 0px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        margin-top: 5px;
        z-index: 10;
        min-width: 126px;
    }

    /* Hide popup initially */
    .hidden {
        display: none;
    }

    /* Style for each option inside popup */
    .popup div {
        padding: 10px 15px;
        cursor: pointer;
        /* width: fit-content; */
    }

    .popup div:hover {
        background-color: #f0f0f0;
    }

    .close-filters {
        display: none;
    }

    svg#close-icon {
        color: black;
    }
</style>

<body>
    <div class="main-container">
        <!-- Search Container -->
        <div class="search-container">
            <div class="search-left">
                <div id="geocoder" style="display: inline-block;"></div>
            </div>
            <div class="search-right">
                <!-- Types Dropdown -->
                <!-- <div class="filter-type-wrapper"> -->
                <!-- <button id="filter-type-btn" onclick="togglePopup('filter-type-popup', 'toggle-icon-type')">
                        Types
                        <svg id="toggle-icon-type" class="toggle-icon" width="20" height="20" viewBox="0 0 24 24"
                            fill="currentColor">
                            <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                    </button> -->
                <!-- <div id="filter-type-popup" class="popup hidden">
                        <div onclick="selectOption('filter-type', '')">Types</div>
                        <div onclick="selectOption('filter-type', 'Single Family Residential')">Single Family
                            Residential</div>
                        <div onclick="selectOption('filter-type', 'Single family Detached')">Single family Detached
                        </div>
                    </div> -->
                <!-- </div> -->

                <!-- Beds Dropdown -->
                <div class="filter-type-wrapper" id="filter-bedrooms-wrapper">
                    <button id="filter-bedrooms-btn"
                        onclick="togglePopup('filter-bedrooms-popup', 'toggle-icon-bedrooms')">
                        Beds
                        <svg id="toggle-icon-bedrooms" class="toggle-icon" width="20" height="20" viewBox="0 0 24 24"
                            fill="currentColor">
                            <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                    </button>
                    <div id="filter-bedrooms-popup" class="popup hidden">
                        <div onclick="selectOption('filter-bedrooms', '')">Beds</div>
                        <div onclick="selectOption('filter-bedrooms', '1')">1+</div>
                        <div onclick="selectOption('filter-bedrooms', '2')">2+</div>
                        <div onclick="selectOption('filter-bedrooms', '3')">3+</div>
                        <div onclick="selectOption('filter-bedrooms', '4')">4+</div>
                    </div>
                </div>

                <!-- Baths Dropdown -->
                <div class="filter-type-wrapper" id="filter-baths-wrapper">
                    <button id="filter-baths-btn" onclick="togglePopup('filter-baths-popup', 'toggle-icon-baths')">
                        Baths
                        <svg id="toggle-icon-baths" class="toggle-icon" width="20" height="20" viewBox="0 0 24 24"
                            fill="currentColor">
                            <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                    </button>
                    <div id="filter-baths-popup" class="popup hidden">
                        <div onclick="selectOption('filter-baths', '')">Baths</div>
                        <div onclick="selectOption('filter-baths', '1')">1+</div>
                        <div onclick="selectOption('filter-baths', '2')">2+</div>
                        <div onclick="selectOption('filter-baths', '3')">3+</div>
                        <div onclick="selectOption('filter-baths', '4')">4+</div>
                    </div>
                </div>

                <!-- Price Range Dropdown -->
                <div class="filter-type-wrapper">
                    <button id="price-range-filter-btn" onclick="togglePopup('price-range-popup', 'toggle-icon-price')">
                        Price
                        <svg id="toggle-icon-price" class="toggle-icon" width="20" height="20" viewBox="0 0 24 24"
                            fill="currentColor">
                            <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                    </button>

                    <div id="price-range-popup" class="popup hidden">
                        <div onclick="selectOption('price-range-filter', '')">Price</div>
                        <div onclick="selectOption('price-range-filter', '2000000+')">$2,000,000+</div>
                        <div onclick="selectOption('price-range-filter', '5000000+')">$5,000,000+</div>
                    </div>
                </div>

                <!-- Hidden Select Elements -->
                <!-- <select id="filter-type" onchange="filterProperties()" style="display: none;">
                    <option value="">Types</option>
                    <option value="Single Family Residential">Single Family Residential</option>
                    <option value="Single Family Detached">Single Family Detached</option>
                </select> -->
                <select id="filter-bedrooms" onchange="filterProperties()" style="display: none;">
                    <option value="">Beds</option>
                    <option value="1">1+</option>
                    <option value="2">2+</option>
                    <option value="3">3+</option>
                    <option value="4">4+</option>
                </select>
                <select id="filter-baths" onchange="filterProperties()" style="display: none;">
                    <option value="">Baths</option>
                    <option value="1">1+</option>
                    <option value="2">2+</option>
                    <option value="3">3+</option>
                    <option value="4">4+</option>
                </select>
                <select id="price-range-filter" onchange="filterProperties()" style="display: none;">
                    <option value="">Price</option>
                    <option value="2000000+">$2,000,000+</option>
                    <option value="5000000+">$5,000,000+</option>
                </select>

                <!-- More filters -->
                <div class="more-filters">
                    <button id="more-filters-btn" type="button">More</button>
                    <div class="more-filters-content">
                        <div class="close-filters">
                            <span class="property-count">0 Results Found</span>
                            <button type="button" id="close-filters-btn">
                                <svg id="close-icon" width="14" height="14" viewBox="0 0 32 32" aria-hidden="true"
                                    focusable="false" role="img" fill="currentColor">
                                    <path
                                        d="M18.83,16,29.41,5.41a2,2,0,0,0-2.82-2.82L16,13.17,5.41,2.59A2,2,0,0,0,2.59,5.41L13.17,16,2.59,26.59a2,2,0,1,0,2.82,2.82L16,18.83,26.59,29.41a2,2,0,0,0,2.82-2.82Z">
                                    </path>
                                </svg>
                            </button>
                        </div>

                        <!-- More Filters Content -->
                        <div class="more-filters-filter">
                            <div class="more-filters-phone-only">
                                <div class="more-filters-mobile-only">
                                    <select id="filter-bedrooms" onchange="filterProperties()">
                                        <option value="">Beds</option>
                                        <option value="1">1+</option>
                                        <option value="2">2+</option>
                                        <option value="3">3+</option>
                                        <option value="4">4+</option>
                                    </select>
                                    <select id="filter-baths" onchange="filterProperties()">
                                        <option value="">Baths</option>
                                        <option value="1">1+</option>
                                        <option value="2">2+</option>
                                        <option value="3">3+</option>
                                        <option value="4">4+</option>
                                    </select>
                                </div>

                                <!-- Min and Max Square Feet Inputs -->
                                <div>
                                    <h4 class="more-filters-title">Square Feet</h4>
                                    <div class="square-feet">
                                        <select name="square-feet" id="min-square-feet" onchange="filterProperties()"
                                            placeholder="Minimum">
                                            <option value="">Any</option>
                                            <option value="4000+">4000+</option>
                                            <option value="4500+">4500+</option>
                                            <option value="5000+">5000+</option>
                                            <option value="5500+">5500+</option>
                                            <option value="6000+">6000+</option>
                                        </select>
                                        <!-- <select name="square-feet" id="max-square-feet" onchange="filterProperties()"
                                        placeholder="Maximum">
                                        <option value="">Max</option>
                                        <option value="4500">4500</option>
                                        <option value="5000">5000</option>
                                        <option value="5500">5500</option>
                                        <option value="6000">6000</option>
                                        <option value="6500">6500</option>
                                    </select> -->
                                    </div>
                                </div>

                                <!-- Min and Max Lot Size Inputs -->
                                <div>
                                    <h4 class="more-filters-title">Lot Size</h4>
                                    <div class="lot-size">
                                        <select name="lot-size" id="min-lot-size" onchange="filterProperties()">
                                            <option value="">Any</option>
                                            <option value="3000+">3000+</option>
                                            <option value="5000+">5000+</option>
                                            <option value="7000+">7000+</option>
                                            <option value="10000+">10000+</option>
                                            <option value="20000+">20000+</option>
                                        </select>
                                        <!-- <select name="lot-size" id="max-lot-size" onchange="filterProperties()">
                                        <option value="">Max</option>
                                        <option value="5000">5000</option>
                                        <option value="7000">7000</option>
                                        <option value="10000">10000</option>
                                        <option value="20000">20000</option>
                                        <option value="50000">50000</option>
                                    </select> -->
                                    </div>
                                </div>

                                <!-- HOA Filter -->
                                <!-- <div>
                                <h4 class="more-filters-title">HOA</h4>
                                <select id="hoa-filter" onchange="filterProperties()">
                                    <option value="">Any</option>
                                    <option value="0">No HOA Fee</option>
                                    <option value="500">$500+ / month</option>
                                </select>
                            </div> -->

                                <!-- Floors Filter -->
                                <div>
                                    <h4 class="more-filters-title">Floors</h4>
                                    <select name="floors" id="floors-filter" onchange="filterProperties()">
                                        <option value="">Any</option>
                                        <option value="1">1+</option>
                                        <option value="2">2+</option>
                                        <option value="3">3+</option>
                                        <option value="4">4+</option>
                                    </select>
                                </div>

                                <!-- Garage Checkbox -->
                                <!-- <div>
                                <label class="more-filters-label"><input type="checkbox" id="garage-filter"
                                        onchange="filterProperties()" /> Garage</label>
                            </div> -->

                                <!-- Amenities Checkboxes -->
                                <!-- <div>
                                 <label class="more-filters-label"><input type="checkbox" name="amenities" value="pool"
                                    onchange="filterProperties()" /> Pool</label>
                                    <label class="more-filters-label"><input type="checkbox" name="amenities" value="gym"
                                        onchange="filterProperties()" /> Gym</label> 
                        </div> -->

                                <!-- With Basement and 3D Tour -->
                                <!-- <div>
                                    <h4 class="more-filters-title">Amenities</h4>
                                    <label class="more-filters-label"><input type="checkbox" id="with-basement-filter"
                                            onchange="filterProperties()" /> With Basement</label>
                                    <label class="more-filters-label"><input type="checkbox" id="threedtour-filter"
                                            onchange="filterProperties()" /> Must have 3D Tour</label>
                                </div> -->
                            </div>
                            <div class="more-filters-fixed-buttons">
                                <button type="button" id="apply-filters-btn" onclick="closeMoreFilters()">Apply</button>
                                <button class="apply-filters-btn-mobile" onclick="resetFilters()"
                                    type="button">Reset</button>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="apply-filters-btn-desktop" onclick="resetFilters()" type="button">Reset Filters</button>
            </div>
        </div>

        <!-- Map and Listing -->
        <div class="map-and-listing">
            <!-- Map Container -->
            <div class="map-container" id="map"></div>

            <!-- Listing Container -->
            <div class="listing-container">
                <h1 class="location-title">All Properties</h1>
                <div class="view-toggle">
                    <h4 class="property-count">0 Results Found</h4>
                    <div class="sorrting-div">
                        <h4 class="view-toggle-title">Sort By:</h4>
                        <!-- Sort Dropdown -->
                        <select id="sort-by" onchange="sortAndFilterProperties()">
                            <option value="default">Default</option>
                            <option value="price-asc">Price: Low to High</option>
                            <option value="price-desc">Price: High to Low</option>
                            <option value="size-asc">Area: Small to Large</option>
                            <option value="size-desc">Area: Large to Small</option>
                            <option value="lot-asc">Lot: Small to Large</option>
                            <option value="lot-desc">Lot: Large to Small</option>
                        </select>
                    </div>
                </div>
                <div id="property-list" class="grid-view"></div>
            </div>
        </div>

        <!-- Mobile Toggle Buttons (only visible on mobile devices) -->
        <div class="mobile-toggle-buttons">
            <button id="mobile-listing-btn" class="active">
                <span>
                    <svg width="18" height="17" viewBox="0 0 18 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M6.75 -0.0078125H2.25C1.9019 -0.0078125 1.56806 0.130468 1.32192 0.37661C1.07578 0.622751 0.9375 0.956591 0.9375 1.30469V5.80469C0.9375 5.97705 0.971449 6.14772 1.03741 6.30696C1.10337 6.4662 1.20005 6.61089 1.32192 6.73277C1.4438 6.85464 1.58849 6.95132 1.74773 7.01728C1.90697 7.08324 2.07764 7.11719 2.25 7.11719H6.75C6.92236 7.11719 7.09303 7.08324 7.25227 7.01728C7.41151 6.95132 7.5562 6.85464 7.67808 6.73277C7.79995 6.61089 7.89663 6.4662 7.96259 6.30696C8.02855 6.14772 8.0625 5.97705 8.0625 5.80469V1.30469C8.0625 1.13233 8.02855 0.961655 7.96259 0.802416C7.89663 0.643176 7.79995 0.498487 7.67808 0.37661C7.5562 0.254733 7.41151 0.158055 7.25227 0.0920955C7.09303 0.0261362 6.92236 -0.0078125 6.75 -0.0078125ZM6.9375 5.80469C6.9375 5.85442 6.91775 5.90211 6.88258 5.93727C6.84742 5.97243 6.79973 5.99219 6.75 5.99219H2.25C2.20027 5.99219 2.15258 5.97243 2.11742 5.93727C2.08225 5.90211 2.0625 5.85442 2.0625 5.80469V1.30469C2.0625 1.25496 2.08225 1.20727 2.11742 1.1721C2.15258 1.13694 2.20027 1.11719 2.25 1.11719H6.75C6.79973 1.11719 6.84742 1.13694 6.88258 1.1721C6.91775 1.20727 6.9375 1.25496 6.9375 1.30469V5.80469ZM15.75 -0.0078125H11.25C10.9019 -0.0078125 10.5681 0.130468 10.3219 0.37661C10.0758 0.622751 9.9375 0.956591 9.9375 1.30469V5.80469C9.9375 5.97705 9.97145 6.14772 10.0374 6.30696C10.1034 6.4662 10.2 6.61089 10.3219 6.73277C10.4438 6.85464 10.5885 6.95132 10.7477 7.01728C10.907 7.08324 11.0776 7.11719 11.25 7.11719H15.75C15.9224 7.11719 16.093 7.08324 16.2523 7.01728C16.4115 6.95132 16.5562 6.85464 16.6781 6.73277C16.8 6.61089 16.8966 6.4662 16.9626 6.30696C17.0286 6.14772 17.0625 5.97705 17.0625 5.80469V1.30469C17.0625 0.956591 16.9242 0.622751 16.6781 0.37661C16.4319 0.130468 16.0981 -0.0078125 15.75 -0.0078125ZM15.9375 5.80469C15.9375 5.85442 15.9177 5.90211 15.8826 5.93727C15.8474 5.97243 15.7997 5.99219 15.75 5.99219H11.25C11.2003 5.99219 11.1526 5.97243 11.1174 5.93727C11.0823 5.90211 11.0625 5.85442 11.0625 5.80469V1.30469C11.0625 1.25496 11.0823 1.20727 11.1174 1.1721C11.1526 1.13694 11.2003 1.11719 11.25 1.11719H15.75C15.7997 1.11719 15.8474 1.13694 15.8826 1.1721C15.9177 1.20727 15.9375 1.25496 15.9375 1.30469V5.80469ZM6.75 8.99219H2.25C1.9019 8.99219 1.56806 9.13047 1.32192 9.37661C1.07578 9.62275 0.9375 9.95659 0.9375 10.3047V14.8047C0.9375 15.1528 1.07578 15.4866 1.32192 15.7328C1.56806 15.9789 1.9019 16.1172 2.25 16.1172H6.75C6.92236 16.1172 7.09303 16.0832 7.25227 16.0173C7.41151 15.9513 7.5562 15.8546 7.67808 15.7328C7.79995 15.6109 7.89663 15.4662 7.96259 15.307C8.02855 15.1477 8.0625 14.977 8.0625 14.8047V10.3047C8.0625 10.1323 8.02855 9.96165 7.96259 9.80241C7.89663 9.64318 7.79995 9.49849 7.67808 9.37661C7.5562 9.25473 7.41151 9.15806 7.25227 9.0921C7.09303 9.02614 6.92236 8.99219 6.75 8.99219ZM6.9375 14.8047C6.9375 14.8544 6.91775 14.9021 6.88258 14.9373C6.84742 14.9724 6.79973 14.9922 6.75 14.9922H2.25C2.20027 14.9922 2.15258 14.9724 2.11742 14.9373C2.08225 14.9021 2.0625 14.8544 2.0625 14.8047V10.3047C2.0625 10.255 2.08225 10.2073 2.11742 10.1721C2.15258 10.1369 2.20027 10.1172 2.25 10.1172H6.75C6.79973 10.1172 6.84742 10.1369 6.88258 10.1721C6.91775 10.2073 6.9375 10.255 6.9375 10.3047V14.8047ZM15.75 8.99219H11.25C10.9019 8.99219 10.5681 9.13047 10.3219 9.37661C10.0758 9.62275 9.9375 9.95659 9.9375 10.3047V14.8047C9.9375 15.1528 10.0758 15.4866 10.3219 15.7328C10.5681 15.9789 10.9019 16.1172 11.25 16.1172H15.75C16.0981 16.1172 16.4319 15.9789 16.6781 15.7328C16.9242 15.4866 17.0625 15.1528 17.0625 14.8047V10.3047C17.0625 9.95659 16.9242 9.62275 16.6781 9.37661C16.4319 9.13047 16.0981 8.99219 15.75 8.99219ZM15.9375 14.8047C15.9375 14.8544 15.9177 14.9021 15.8826 14.9373C15.8474 14.9724 15.7997 14.9922 15.75 14.9922H11.25C11.2003 14.9922 11.1526 14.9724 11.1174 14.9373C11.0823 14.9021 11.0625 14.8544 11.0625 14.8047V10.3047C11.0625 10.255 11.0823 10.2073 11.1174 10.1721C11.1526 10.1369 11.2003 10.1172 11.25 10.1172H15.75C15.7997 10.1172 15.8474 10.1369 15.8826 10.1721C15.9177 10.2073 15.9375 10.255 15.9375 10.3047V14.8047Z"
                            fill="#FEFEFE" />
                    </svg>
                </span>
                <span>Listings</span>
            </button>
            <button id="mobile-map-btn">
                <span style="display: flex;">
                    <svg width="25" height="22" viewBox="0 0 25 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g filter="url(#filter0_d_10119_10395)">
                            <path
                                d="M21.3616 1.86039C21.2941 1.80778 21.2156 1.77123 21.132 1.75352C21.0483 1.73581 20.9617 1.73742 20.8787 1.7582L15.0812 3.20758L9.26875 0.301329C9.14856 0.24138 9.01089 0.226415 8.88062 0.259141L2.88062 1.75914C2.75883 1.78925 2.6506 1.85922 2.57313 1.95791C2.49567 2.05661 2.45343 2.17837 2.45313 2.30383V15.8038C2.45312 15.8894 2.47262 15.9738 2.51013 16.0506C2.54765 16.1275 2.60219 16.1948 2.66963 16.2474C2.73706 16.3 2.81559 16.3365 2.89927 16.3542C2.98294 16.3719 3.06955 16.3703 3.1525 16.3495L8.95 14.9001L14.7625 17.8063C14.8827 17.8663 15.0204 17.8812 15.1506 17.8485L21.1506 16.3485C21.2724 16.3184 21.3807 16.2484 21.4581 16.1497C21.5356 16.0511 21.5778 15.9293 21.5781 15.8038V2.30383C21.5781 2.21832 21.5586 2.13393 21.5211 2.05709C21.4835 1.98025 21.429 1.91298 21.3616 1.86039ZM9.57812 1.71414L14.4531 4.15164V16.3935L9.57812 13.956V1.71414ZM3.57812 2.74539L8.45312 1.52664V13.8651L3.57812 15.0838V2.74539ZM20.4531 15.3651L15.5781 16.5838V4.24258L20.4531 3.02383V15.3651Z"
                                fill="#FEFEFE" />
                        </g>
                        <defs>
                            <filter id="filter0_d_10119_10395" x="-1.54688" y="0.242188" width="27.125" height="25.623"
                                filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                                <feFlood flood-opacity="0" result="BackgroundImageFix" />
                                <feColorMatrix in="SourceAlpha" type="matrix"
                                    values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha" />
                                <feOffset dy="4" />
                                <feGaussianBlur stdDeviation="2" />
                                <feComposite in2="hardAlpha" operator="out" />
                                <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0" />
                                <feBlend mode="normal" in2="BackgroundImageFix"
                                    result="effect1_dropShadow_10119_10395" />
                                <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_10119_10395"
                                    result="shape" />
                            </filter>
                        </defs>
                    </svg>
                </span>
                <span>Map</span>
            </button>
        </div>
    </div>

    <!-- Mapbox JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js"></script>

    <!-- Mapbox Geocoder JS -->
    <script
        src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>

    <!-- Custom JS -->
    <script>
        mapboxgl.accessToken = 'pk.eyJ1Ijoid2Vid2l0aHJhaiIsImEiOiJjbTBhbGZmMHgxZXFuMm1vcWt4YmNwZGZhIn0.IpNziQwncy2U-Xms017ojA';

        // Define properties globally
        let properties = [];

        fetch('https://rosybrown-goose-111113.hostingersite.com/wp-json/wp/v2/property')
            .then(response => response.json())
            .then(data => {
                properties = data;
                console.log("Fetched Properties:", properties);

                // Sort properties by default to have featured properties at the top
                properties.sort((a, b) => {
                    if (a.featured_check && !b.featured_check) return -1;
                    if (!a.featured_check && b.featured_check) return 1;
                    return 0;
                });

                // Update the property list on initial load
                updatePropertyList(properties);
                document.querySelectorAll('.property-count').forEach(element => {
                    element.textContent = `${properties.length} Results Found`;
                });

                // Optionally fit the map to show all properties
                // fitMapToMarkers(properties);
            })
            .catch(error => console.error('Error fetching properties:', error));


        let markers = [];
        let map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [-98.583333, 39.833333], // Center on USA
            zoom: 3.5 // Adjusted zoom level for USA-wide view
        });

        // Initialize Geocoder
        let geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl,
            placeholder: 'Search by address',
            proximity: {
                longitude: -98.583333,
                latitude: 39.833333
            },
            marker: false
        });
        document.getElementById('geocoder').appendChild(geocoder.onAdd(map));

        // Variables to hold current filters and searched location
        let currentFilters = {
            type: '',
            bedrooms: '',
            baths: '',
            priceRange: '',
            garage: false,
            basement: false,
            threedtour: false,
            amenities: [],
            minSize: '',
            maxSize: '',
            minLotSize: '',
            maxLotSize: '',
            hoa: '',
            floors: '',
            searchLocation: '',
            lat: '',
            lng: ''
        };

        // Function to update URL parameters
        function updateURLParameters() {
            const params = new URLSearchParams();

            // Search location
            if (currentFilters.searchLocation) params.set('search_location', currentFilters.searchLocation);
            if (currentFilters.lat) params.set('lat', currentFilters.lat);
            if (currentFilters.lng) params.set('lng', currentFilters.lng);

            // Filters
            if (currentFilters.type) params.set('type', currentFilters.type);
            if (currentFilters.bedrooms) params.set('bedrooms', currentFilters.bedrooms);
            if (currentFilters.baths) params.set('baths', currentFilters.baths);
            if (currentFilters.priceRange) params.set('price_range', currentFilters.priceRange);
            if (currentFilters.garage) params.set('garage', currentFilters.garage);
            if (currentFilters.basement) params.set('basement', currentFilters.basement);
            if (currentFilters.threedtour) params.set('threedtour', currentFilters.threedtour);
            if (currentFilters.amenities.length > 0) params.set('amenities', currentFilters.amenities.join(','));
            if (currentFilters.minSize) params.set('min_size', currentFilters.minSize);
            if (currentFilters.maxSize) params.set('max_size', currentFilters.maxSize);
            if (currentFilters.minLotSize) params.set('min_lot_size', currentFilters.minLotSize);
            if (currentFilters.maxLotSize) params.set('max_lot_size', currentFilters.maxLotSize);
            if (currentFilters.hoa) params.set('hoa', currentFilters.hoa);
            if (currentFilters.floors) params.set('floors', currentFilters.floors);

            // Update the URL without reloading the page
            const newURL = window.location.pathname + '?' + params.toString();
            history.replaceState(null, '', newURL);
        }

        // Function to get URL parameters on page load
        function getURLParameters() {
            const params = new URLSearchParams(window.location.search);

            // Search location
            const lat = parseFloat(params.get('lat'));
            const lng = parseFloat(params.get('lng'));
            const searchLocation = params.get('search_location') || '';

            if (!isNaN(lat) && !isNaN(lng)) {
                currentFilters.lat = lat;
                currentFilters.lng = lng;
                currentFilters.searchLocation = searchLocation;
                map.setCenter([lng, lat]);
                map.setZoom(10);
                document.querySelector('.location-title').textContent = searchLocation || 'Search Location';
            }

            // Filters
            // currentFilters.type = params.get('type') || '';
            currentFilters.bedrooms = params.get('bedrooms') || '';
            currentFilters.baths = params.get('baths') || '';
            currentFilters.priceRange = params.get('price_range') || '';
            currentFilters.garage = params.get('garage') === 'true';
            currentFilters.basement = params.get('basement') === 'true';
            currentFilters.threedtour = params.get('threedtour') === 'true';
            currentFilters.amenities = params.get('amenities') ? params.get('amenities').split(',') : [];
            currentFilters.minSize = params.get('min_size') || '';
            currentFilters.maxSize = params.get('max_size') || '';
            currentFilters.minLotSize = params.get('min_lot_size') || '';
            currentFilters.maxLotSize = params.get('max_lot_size') || '';
            // currentFilters.hoa = params.get('hoa') || '';
            currentFilters.floors = params.get('floors') || '';

            // Set the filter inputs
            // document.getElementById('filter-type').value = currentFilters.type;
            document.getElementById('filter-bedrooms').value = currentFilters.bedrooms;
            document.getElementById('filter-baths').value = currentFilters.baths;
            document.getElementById('price-range-filter').value = currentFilters.priceRange;
            // document.getElementById('garage-filter').checked = currentFilters.garage;
            // document.getElementById('with-basement-filter').checked = currentFilters.basement;
            // document.getElementById('threedtour-filter').checked = currentFilters.threedtour;
            document.getElementById('min-square-feet').value = currentFilters.minSize;
            // document.getElementById('max-square-feet').value = currentFilters.maxSize;
            document.getElementById('min-lot-size').value = currentFilters.minLotSize;
            // document.getElementById('max-lot-size').value = currentFilters.maxLotSize;
            // document.getElementById('hoa-filter').value = currentFilters.hoa;
            document.getElementById('floors-filter').value = currentFilters.floors;

            // Set amenities checkboxes
            currentFilters.amenities.forEach(amenity => {
                const checkbox = document.querySelector(`input[name="amenities"][value="${amenity}"]`);
                if (checkbox) checkbox.checked = true;
            });

            // Apply filters
            filterProperties();

            // Clear URL parameters after applying filters
            // window.history.replaceState({}, document.title, window.location.pathname);
        }

        // Geocoder result event
        geocoder.on('result', function (e) {
            map.flyTo({ center: e.result.center, zoom: 6, speed: 0.5, curve: 1.5 });
            document.querySelector('.location-title').textContent = e.result.place_name;
            currentFilters.searchLocation = e.result.place_name;
            currentFilters.lat = e.result.center[1];
            currentFilters.lng = e.result.center[0];
            updateURLParameters();
            filterProperties();
        });

        // Function to filter properties
        function filterProperties() {
            // Update current filters
            // currentFilters.type = document.getElementById('filter-type').value;
            currentFilters.bedrooms = document.getElementById('filter-bedrooms').value;
            currentFilters.baths = document.getElementById('filter-baths').value;
            currentFilters.priceRange = document.getElementById('price-range-filter').value;
            // currentFilters.garage = document.getElementById('garage-filter').checked;
            // currentFilters.basement = document.getElementById('with-basement-filter').checked;
            // currentFilters.threedtour = document.getElementById('threedtour-filter').checked;
            currentFilters.amenities = Array.from(document.querySelectorAll('input[name="amenities"]:checked')).map(el => el.value);
            currentFilters.minSize = document.getElementById('min-square-feet').value;
            // currentFilters.maxSize = document.getElementById('max-square-feet').value;
            currentFilters.minLotSize = document.getElementById('min-lot-size').value;
            // currentFilters.maxLotSize = document.getElementById('max-lot-size').value;
            // currentFilters.hoa = document.getElementById('hoa-filter').value;
            currentFilters.floors = document.getElementById('floors-filter').value;

            updateURLParameters();

            // Apply filters based on current map bounds
            filterPropertiesByMapBounds();
        }

        /**
         * Parses the property price string to extract lower and upper bounds.
         * Handles formats like "1650000", "1650000 - 2175000", "(1650000 - 2175000)", "5000000+", "Price on Request", etc.
         * @param {string} priceString - The price string from the property data.
         * @returns {Object} - An object containing priceLower and priceUpper.
         */
        function parsePropertyPrice(priceString) {
            priceString = priceString.trim();

            if (priceString.toLowerCase() === 'price on request') {
                return { priceLower: 0, priceUpper: Infinity }; // Treat as an unknown price
            }

            const normalizedPrice = priceString.replace(/[\u2012\u2013\u2014\u2212]/g, '-');
            const cleanedPrice = normalizedPrice.replace(/[^0-9.-]/g, '');
            const prices = cleanedPrice.split('-').map(p => parseFloat(p.trim()));

            let priceLower = 0;
            let priceUpper = Infinity;

            if (prices.length === 2 && !isNaN(prices[0]) && !isNaN(prices[1])) {
                priceLower = prices[0];
                priceUpper = prices[1];
            } else if (prices.length === 1 && !isNaN(prices[0])) {
                priceLower = prices[0];
                priceUpper = priceString.includes('+') ? Infinity : prices[0]; // Handle "$2,000,000+" case
            } else {
                console.error('Invalid price format:', priceString);
            }

            return { priceLower, priceUpper };
        }


        // Function to filter properties based on current filters and map bounds
        function filterPropertiesByMapBounds() {
            const bounds = map.getBounds();

            // Parse current filter price range
            let minPrice = 0;
            let maxPrice = Infinity;

            if (currentFilters.priceRange) {
                const filterPriceCleaned = currentFilters.priceRange.replace(/\+/g, '');
                const filterPrices = filterPriceCleaned.split('-').map(p => parseFloat(p.replace(/[^0-9.]/g, '')));
                minPrice = filterPrices[0] || 0;
                maxPrice = filterPrices[1] || Infinity;
            }
            // Parse current filter area size range
            let minAreaSize = parseInt(currentFilters.minSize.replace(/[^0-9]/g, '')) || 0;
            let maxAreaSize = parseInt(currentFilters.maxSize.replace(/[^0-9]/g, '')) || Infinity;

            let minSize = parseInt(currentFilters.minSize.replace(/[^0-9]/g, '')) || 0;
            let maxSize = parseInt(currentFilters.maxSize.replace(/[^0-9]/g, '')) || Infinity;
            let minLotSize = parseInt(currentFilters.minLotSize.replace(/[^0-9]/g, '')) || 0;
            let maxLotSize = parseInt(currentFilters.maxLotSize.replace(/[^0-9]/g, '')) || Infinity;



            // Filter properties
            const filteredProperties = properties.filter((property) => {
                let parsedPosition;
                try {
                    parsedPosition = JSON.parse(property.position);
                } catch (error) {
                    return false; // Skip if parsing fails
                }

                if (!Array.isArray(parsedPosition) || parsedPosition.length !== 2) {
                    return false;
                }

                const [longitude, latitude] = parsedPosition;
                const coordinates = [longitude, latitude];
                const isWithinBounds = bounds.contains(coordinates);
                console.log(`Property Coordinates: ${coordinates}, Is Within Bounds: ${isWithinBounds}`);

                // Parse property price using the new function
                const { priceLower, priceUpper } = parsePropertyPrice(property.price);

                // Check if the filter price range overlaps with the property's price range
                const matchesPriceFilter = (
                    !currentFilters.priceRange ||
                    (priceLower <= maxPrice)(priceUpper >= minPrice)
                );

                const propertyAreaSize = parseFloat(property.area_size) || 0; // Use 0 as a fallback if parsing fails

                // Check if the filter area size range overlaps with the property's area size
                const matchesAreaSizeFilter = (!property.area_size && minAreaSize === 0) ||
                    (propertyAreaSize >= minAreaSize && propertyAreaSize <= maxAreaSize);


                // Apply other filters
                const matchesFilters =
                    (!currentFilters.bedrooms || property.bedrooms >= parseInt(currentFilters.bedrooms)) &&
                    (!currentFilters.baths || property.baths >= parseFloat(currentFilters.baths)) &&
                    (!currentFilters.garage || property.garage) &&
                    (!currentFilters.basement || property.basement) &&
                    (!currentFilters.threedtour || property.must_have_3d_tour) &&
                    (!currentFilters.floors || property.floors >= parseInt(currentFilters.floors)) &&
                    matchesPriceFilter &&
                    (property.area_size ? matchesAreaSizeFilter : true) &&
                    (property.lot_size >= minLotSize) &&
                    currentFilters.amenities.every(amenity => property.amenities.includes(amenity));

                return isWithinBounds && matchesFilters;
            });

            updatePropertyList(filteredProperties);
            document.querySelectorAll('.property-count').forEach(element => {
                element.textContent = `${filteredProperties.length} Results Found`;
            });
        }

        // Debounce function to limit how often a function can fire
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Added event listener to map to update properties when map moves
        map.on('moveend', debounce(filterPropertiesByMapBounds, 200));

        // Function to fit map to markers (Enhancement)
        function fitMapToMarkers(propertiesToShow) {
            const bounds = new mapboxgl.LngLatBounds();

            propertiesToShow.forEach(property => {
                let parsedPosition;
                try {
                    parsedPosition = JSON.parse(property.position);
                } catch (error) {
                    // console.error("Failed to parse position string:", property.position, "Error:", error);
                    return;
                }

                if (Array.isArray(parsedPosition) && parsedPosition.length === 2) {
                    bounds.extend(parsedPosition);
                }
            });

            if (!bounds.isEmpty()) {
                map.fitBounds(bounds, { padding: 50 });
            }
        }

        // Update property list and markers based on filtered properties
        function updatePropertyList(propertiesToShow) {
            const propertyList = document.getElementById('property-list');
            propertyList.innerHTML = '';

            // Remove existing markers from the map
            markers.forEach(marker => marker.remove());
            markers = [];

            if (propertiesToShow.length === 0) {
                propertyList.innerHTML = '<p>No properties found based on the selected criteria.</p>';
                return;
            }

            propertiesToShow.forEach((property, index) => {
                // Directly parse the position string
                let parsedPosition;
                try {
                    parsedPosition = JSON.parse(property.position);
                    // console.log(`Property ${index + 1} - Parsed Position:`, parsedPosition);
                } catch (error) {
                    console.error(`Property ${index + 1} - Failed to parse position string "${property.position}":`, error);
                    return; // Skip if parsing fails
                }

                // Ensure parsedPosition is an array with two elements
                if (!Array.isArray(parsedPosition) || parsedPosition.length !== 2) {
                    console.error(`Property ${index + 1} - Invalid position format:`, parsedPosition);
                    return;
                }

                const [longitude, latitude] = parsedPosition; // Mapbox expects [lng, lat]
                const coordinates = [longitude, latitude];


                // if (property.baths = "") {
                //     console.warn(`Property ${index + 1} - Missing 'baths' field.`);
                // } else {
                //     console.log(`Property ${index + 1} - baths:`, property.baths);
                // }

                // Create the property listing item
                const propertyItem = document.createElement('div');
                propertyItem.classList.add('property-item');
                propertyItem.innerHTML = `
            ${property.featured_check ? '<span class="featured-label">Featured</span>' : ''}
            <div class="property-image-container">
                <img src="${property.featured_image || 'https://via.placeholder.com/400'}" alt="Property at ${property.address}" class="property-image" />
            </div>
            <p class="price">$ ${property.price.toLocaleString()}</p>
            <div class="details">
                <p class="property-address">${property.address}</p>
                <p class="property-amenities">${property.bedrooms ? property.bedrooms + ` Beds |` : ''}   ${property.baths ? property.baths + ` Baths | ` : ''}   ${property.area_size ? `AC Area: ` + property.area_size + ` Sqft  ` : ''} </p>
                <p class="property-type">${property.types}</p>
            </div>
        `;
                // <p class="property-amenities"> ${property.lot_size ? ` Lot Size: ` + property.lot_size + ` Sqft` : ''} </p>

                propertyList.appendChild(propertyItem);

                // Redirect to property link when card is clicked
                propertyItem.addEventListener('click', () => {
                    if (property.link) {
                        window.open(property.link, '_self');
                    } else {
                        console.error(`Property ${index + 1} - 'link' is undefined:`, property);
                    }
                });

                // Create the popup content wrapped in an <a> tag
                const popupHTML = property.link ? `
            <a href="${property.link}" style="text-decoration: none; color: inherit;">
                <div class="property-map-card">
                    <div class="property-map-image-container">
                        <img src="${property.featured_image}" alt="Property at ${property.address}" class="property-map-image" />
                    </div>
                    <div class="property-map-details">
                    <h3 class="property-map-title">${property.title.rendered}</h3>
                    <p class="property-map-price">$${property.price.toLocaleString()}</p>
                    <p class="property-map-type">${property.types}</p>
                    </div>
                </div>
            </a>
        ` : `
            <div class="property-map-card">
                <div class="property-map-image-container">
                    <img src="${property.featured_image || 'https://via.placeholder.com/400'}" alt="Property at ${property.address}" class="property-map-image" />
                </div>
                <h3 class="property-map-title">${property.title.rendered}</h3>
                <p class="property-map-price">$ ${property.price.toLocaleString()}</p>
                <p class="property-map-type">${property.types}</p>
            </div>
        `;

                const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(popupHTML);

                const redPinUrl = 'https://upload.wikimedia.org/wikipedia/commons/a/a7/Red_dot.svg'; // URL of a red pin icon

                // Add the marker to the map using parsedPosition
                const marker = new mapboxgl.Marker({
                    color: 'red'  // Alternatively, you can directly use the color property
                })
                    .setLngLat(coordinates) // Use parsedPosition directly
                    .setPopup(popup)
                    .addTo(map);

                markers.push(marker);


                // No need for separate event listener since the popup's content is an anchor tag

                // Add hover event listeners to the property item
                propertyItem.addEventListener('mouseover', () => {
                    marker.getPopup().addTo(map);
                });

                propertyItem.addEventListener('mouseout', () => {
                    marker.getPopup().remove();
                });
            });

            // Optionally fit the map to the markers
            // fitMapToMarkers(propertiesToShow);
        }

        function resetFilters() {
            // document.getElementById('filter-type').value = '';
            document.getElementById('filter-bedrooms').value = '';
            document.getElementById('filter-baths').value = '';
            document.getElementById('price-range-filter').value = '';
            // document.getElementById('garage-filter').checked = false;
            // document.getElementById('with-basement-filter').checked = false;
            // document.getElementById('threedtour-filter').checked = false;
            document.getElementById('min-square-feet').value = '';
            // document.getElementById('max-square-feet').value = '';
            document.getElementById('min-lot-size').value = '';
            // document.getElementById('max-lot-size').value = '';
            // document.getElementById('hoa-filter').value = '';
            document.getElementById('floors-filter').value = '';
            document.querySelectorAll('input[name="amenities"]').forEach(el => el.checked = false);

            // Update the button text to show the placeholder text
            document.querySelectorAll('.filter-type-wrapper button').forEach(button => {
                const selectId = button.id.replace('-btn', '');
                const selectElement = document.getElementById(selectId);
                if (selectElement) {
                    button.firstChild.textContent = selectElement.options[0].textContent;
                }
            });

            filterProperties();
        }


        // Sort properties
        function sortAndFilterProperties() {
            filterProperties();
            sortProperties();
        }

        function sortProperties() {
            const sortBy = document.getElementById('sort-by').value;

            const sortedProperties = [...properties]; // Clone the array to avoid mutating the original

            sortedProperties.sort((a, b) => {
                if (sortBy === 'default') {
                    if (a.featured_check && !b.featured_check) return -1;
                    if (!a.featured_check && b.featured_check) return 1;
                    return 0;
                }

                switch (sortBy) {
                    case 'price-asc':
                        return a.price - b.price;
                    case 'price-desc':
                        return b.price - a.price;
                    case 'size-asc':
                        return a.area_size - b.area_size;
                    case 'size-desc':
                        return b.area_size - a.area_size;
                    case 'lot-asc':
                        return a.lot_size - b.lot_size;
                    case 'lot-desc':
                        return b.lot_size - a.lot_size;
                    default:
                        return 0;
                }
            });

            updatePropertyList(sortedProperties);
            document.querySelectorAll('.property-count').forEach(element => {
                element.textContent = `${sortedProperties.length} Results Found`;
            });
        }

        // Popup functionality
        function togglePopup(popupId, iconId) {
            const popup = document.getElementById(popupId);
            const icon = document.getElementById(iconId);
            popup.classList.toggle('hidden');
            icon.classList.toggle('rotate-icon');
        }

        function selectOption(selectId, value) {
            const selectElement = document.getElementById(selectId);
            const buttonElement = document.querySelector(`#${selectId}-btn`);

            if (buttonElement) {
                // Set button text based on the selected value
                const buttonText = buttonElement.firstChild;
                if (value) {
                    buttonText.textContent = value.includes('+') ? `$${parseInt(value).toLocaleString()}+` : value;
                } else {
                    buttonText.textContent = selectElement.options[0].textContent; // Default text
                }
            }

            selectElement.value = value;
            selectElement.dispatchEvent(new Event('change'));

            // Close the popup after selection
            const popupElement = document.getElementById(`${selectId}-popup`);
            if (popupElement) {
                popupElement.classList.add('hidden');
            }

            // Reset the toggle icon rotation
            const toggleIcon = document.getElementById(`toggle-icon-${selectId.split('-')[1]}`);
            if (toggleIcon) {
                toggleIcon.classList.remove('rotate-icon');
            }
        }



        document.addEventListener('click', (event) => {
            const wrappers = document.querySelectorAll('.filter-type-wrapper');
            wrappers.forEach(wrapper => {
                if (!wrapper.contains(event.target)) {
                    const popup = wrapper.querySelector('.popup');
                    if (popup) {
                        popup.classList.add('hidden');
                    }
                    const icon = wrapper.querySelector('.toggle-icon');
                    if (icon) {
                        icon.classList.remove('rotate-icon');
                    }
                }
            });
        });

        // Mobile toggle buttons functionality
        document.getElementById('mobile-listing-btn').addEventListener('click', function () {
            document.querySelector('.map-container').style.display = 'none';
            document.querySelector('.listing-container').style.display = 'block';
            this.classList.add('active');
            document.getElementById('mobile-map-btn').classList.remove('active');
        });

        document.getElementById('mobile-map-btn').addEventListener('click', function () {
            document.querySelector('.map-container').style.display = 'block';
            document.querySelector('.listing-container').style.display = 'none';
            this.classList.add('active');
            document.getElementById('mobile-listing-btn').classList.remove('active');
            map.resize();
        });


        // More Filters toggle functionality
        document.getElementById('more-filters-btn').addEventListener('click', function () {
            document.querySelector('.more-filters-content').classList.toggle('show');
        });

        // More Filters close button functionality
        document.getElementById('close-filters-btn').addEventListener('click', function () {
            document.querySelector('.more-filters-content').classList.remove('show');
        });

        function closeMoreFilters() {
            document.querySelector('.more-filters-content').classList.remove('show');
        }

        // Call getURLParameters on page load
        window.onload = function () {
            const currentUrl = window.location.href;
            const lastUrl = sessionStorage.getItem('lastUrl');

            if (lastUrl !== currentUrl) {
                // First load or URL has changed: process URL parameters
                getURLParameters();
                filterProperties();
                sessionStorage.setItem('lastUrl', currentUrl);
            } else {
                // Same URL as before: reset filters
                resetFilters();
                filterProperties();
            }
        };
    </script>

</body>